<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç¾é£Ÿæ¨è–¦å™¨</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
body {
  font-family: "Noto Sans TC", sans-serif;
  background: #fff8f0;
  color: #4a3b2c;
  margin: 0;
  padding: 0;
}

.hero {
  background-image: url("https://img.freepik.com/premium-vector/food-pattern-seamless_534604-531.jpg");
  background-size: cover;
  background-position: center;
  color: #fff8f0;
  text-align: center;
  padding: 4rem 1rem;
  position: relative;
}

.hero::after {
  content: "";
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(245, 139, 84, 0.3);
  z-index: 0;
}

.hero h1 {
  position: relative; z-index: 1;
  font-size: 2.8rem;
  letter-spacing: 0.05em;
  font-weight: 700;
  color: #fff8f0;
  margin: 0;
  text-shadow: 1px 1px 4px rgba(0,0,0,0.1);
}

header {
  background: #f4c095;
  display: flex;
  justify-content: center;
  gap: 2rem;
  padding: 1rem 0;
  position: sticky;
  top: 0;
  z-index: 2;
  border-bottom: 2px solid #f58b54;
}

header a {
  text-decoration: none;
  color: #4a3b2c;
  font-weight: 600;
  font-size: 1.1rem;
  transition: 0.3s;
}

header a:hover { color: #f58b54; }

section {
  display: none;
  padding: 2rem;
  max-width: 700px;
  margin: auto;
  background: #fff0e6;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(245, 139, 84, 0.15);
  margin-top: 2rem;
  border: 1px solid #f4c095;
}

section.active { display: block; }

h2 {
  text-align: center;
  color: #f58b54;
  border-bottom: 2px solid #f58b54;
  padding-bottom: 0.5rem;
}

label { display: block; margin: 10px 0; color: #4a3b2c; }

select, input[type="text"], button {
  width: 100%;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #f4c095;
  font-size: 1rem;
  background: #fff8f0;
  color: #4a3b2c;
}

select:focus, input[type="text"]:focus {
  outline: none;
  border-color: #f58b54;
  box-shadow: 0 0 5px #f58b54;
}

.checkbox-group {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.checkbox-group label {
  display: inline-flex;        /* è®“ checkbox å’Œæ–‡å­—æ°´å¹³æ’åˆ— */
  align-items: center;         /* å‚ç›´ç½®ä¸­ */
  gap: 6px;                    /* checkbox å’Œæ–‡å­—çš„è·é›¢ */
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
  border: 1px solid #f4c095;
  background: #fff0e6;
  white-space: nowrap;         /* ğŸ”¥ é˜²æ­¢æ›è¡Œ */
  width: auto;                 /* ğŸ”¥ è®“æ¡†æ¡†å›ºå®šåœ¨æœ€é©å¯¬åº¦ï¼Œä¸æœƒäº‚æ’ */
}

.checkbox-group label:hover { background: #ffe3d1; }

button {
  background-color: #f58b54;
  color: white;
  border: none;
  cursor: pointer;
  margin-top: 20px;
  font-weight: 700;
  transition: 0.3s;
}

button:hover { background-color: #f79465; }

#map, #mapFilter, #mapCustom {
  height: 300px;
  width: 100%;
  margin-top: 10px;
  border-radius: 12px;
}

/* ç™»å…¥å€ */
#loginArea {
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 9999; /* èª¿é«˜åˆ°æœ€ä¸Šå±¤ */
  background: #f4c095;
  padding: 5px 10px;
  border-radius: 8px;
  border: 1px solid #f58b54;
  display: flex;
  flex-direction: column;  /* å…ˆä¸Šä¸‹æ’åˆ— */
  align-items: flex-start; /* æ–‡å­—é å·¦ */
}

#loginArea .buttons {
  display: flex;       /* è®“æŒ‰éˆ•æ°´å¹³æ’åˆ— */
  gap: 5px;            /* æŒ‰éˆ•é–“è· */
}

/* Modal èƒŒæ™¯ */
.modal {
  display: none;
  position: fixed;
  top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;
  z-index: 10000; /* Modal æ°¸é åœ¨ç™»å…¥å€ä¹‹ä¸Š */
}

/* Modal å…§å®¹ */
.modal-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  min-width: 300px;
  position: relative;
  z-index: 10001; /* ç¢ºä¿æŒ‰éˆ•ã€æ¡†æ¡†åœ¨æœ€ä¸Šå±¤ */
}

/* å¸³è™Ÿå¯†ç¢¼æ¡† */
.modal-content input {
  background-color: white;
  border: 1px solid black;
  border-radius: 4px;
  padding: 5px;
  width: 100%;
  height: 30px;
  outline: none;
  box-sizing: border-box;
  font-size: 14px;
}

.modal-content input:focus {
  border: 1px solid black;
  box-shadow: none;
}

/* Modal æŒ‰éˆ• */
.modal-content button {
  background: #f58b54;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.close {
  position: absolute; top: 8px; right: 12px; cursor: pointer; font-size: 20px;
}
input { width: 90%; padding: 5px; margin-bottom: 10px; }
button { padding: 5px 10px; }

/* æ”¶è—å´æ¬„ */
#toggleFavorites {
  position: fixed;
  top: 90px;
  left: 20px;
  background-color: #ff8c42; /* æ©˜è‰²ä¸»é¡Œ */
  color: white;
  border: none;
  border-radius: 8px;
  padding: 10px 16px;
  font-size: 18px;
  cursor: pointer;
  z-index: 1100;
  width: auto;       /* ğŸ”¸ä¸è¢«æ‹‰æ»¿ */
  height: auto;      /* ğŸ”¸é«˜åº¦è‡ªå‹• */
  display: inline-block;
  transition: background 0.3s;
}

#toggleFavorites:hover {
  background-color: #ff7b2e;
}

#favoriteSidebar {
  position: fixed;
  top: 0; left: -300px;
  width: 280px; height: 100%;
  background-color: #fff8f0;
  box-shadow: 2px 0 10px rgba(0,0,0,0.2);
  overflow-y: auto;
  transition: left 0.4s ease;
  z-index: 1000;
  padding: 150px 20px 20px 20px;
}

#favoriteSidebar h3 {
  color: #ff8c42;
  margin-bottom: 10px;
  font-weight: bold;
  /* å¯ä»¥é¡å¤–åŠ  margin-top å¾®èª¿ */
  margin-top: 20px; 
}

#favoriteSidebar.active { left: 0; }

#favoriteSidebar ul { list-style: none; padding: 0; }

#favoriteSidebar li {
    display: flex;
    justify-content: space-between; /* æ–‡å­—é å·¦ï¼ŒæŒ‰éˆ•é å³ */
    align-items: flex-start;        /* å…ƒç´ é ä¸Šå°é½Š */
    padding: 6px 0;
    border-bottom: 1px solid #f4c095;
  }

  /* æ–‡å­—ç¨å¾®ä¸‹ç§» */
  #favoriteSidebar li span {
    display: inline-block;
    transform: translateY(6px); /* èª¿æ•´æ•¸å€¼å¯å¾®èª¿æ–‡å­—é«˜åº¦ */
  }

  /* åˆªé™¤æŒ‰éˆ•ç¶­æŒåŸä½ */
  #favoritesUl li button {
    font-size: 1.1rem;
    cursor: pointer;
  }

  .category-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 1rem;
  }

  .category-buttons button {
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid #f4c095;
    background: #fff0e6;
    color: #4a3b2c;
    cursor: pointer;
    transition: 0.3s;
    }

  .category-buttons button:hover {
    background: #ffe3d1;
  }

  #restaurantList li {
    padding: 8px;
    border-bottom: 1px solid #f4c095;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  #searchArea input {
    padding: 5px;
    width: 250px;
    margin-right: 10px;
  }

/* ç•™è¨€å€ */
#reviewArea {
    margin-top: 20px;
  }

  .rating-group {
    margin-bottom: 10px;
  }

  .rating-row {
    margin-bottom: 5px;
  }

  .stars {
    display: inline-block;
    cursor: pointer;
    color: gold;
  }

  .stars span {
    font-size: 24px;
    cursor: pointer;
    color: lightgray; /* åˆå§‹ç°è‰² */
    transition: color 0.2s;
  }

  .stars span:hover,
  .stars span:hover ~ span {
    color: gold; /* æ»‘é¼ æ»‘éæ•ˆæœ */
  }

  #reviewsUl li {
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between; /* ğŸ”¥ å·¦å³å…©é‚Šé æœ€é‚Š */
    align-items: center;            /* å‚ç›´ç½®ä¸­ */
    padding: 6px 0;
  }

  #reviewsUl button {
    margin-left: 10px;
    cursor: pointer;
    width: 80px; 
    background: rgb(252, 86, 86);
  }
</style>
</head>
<body>

<!-- ç™»å…¥å€ -->
<div id="loginArea">
  <span id="welcomeText">æœªç™»å…¥</span>
  <div class="buttons">
    <button id="loginBtn">ç™»å…¥</button>
    <button id="registerBtn">è¨»å†Š</button>
  </div>
</div>

<!-- ç™»å…¥ Modal -->
<div id="loginModal" class="modal" onclick="clickOutside(event,'loginModal')">
  <div class="modal-content">
    <span class="close" onclick="closeLoginModal()">&times;</span>
    <h2>ç™»å…¥</h2>
    <input type="text" id="loginUsername" placeholder="å¸³è™Ÿ"><br>
    <input type="password" id="loginPassword" placeholder="å¯†ç¢¼"><br>
    <button onclick="login()">ç™»å…¥</button>
    <p>æ²’æœ‰å¸³è™Ÿï¼Ÿ<a href="#" onclick="openRegister()">è¨»å†Š</a></p>
  </div>
</div>

<!-- è¨»å†Š Modal -->
<div id="registerModal" class="modal" onclick="clickOutside(event,'registerModal')">
  <div class="modal-content">
    <span class="close" onclick="closeRegisterModal()">&times;</span>
    <h2>è¨»å†Š</h2>
    <input type="text" id="registerUsername" placeholder="å¸³è™Ÿ"><br>
    <input type="password" id="registerPassword" placeholder="å¯†ç¢¼"><br>
    <input type="password" id="registerPasswordConfirm" placeholder="ç¢ºèªå¯†ç¢¼"><br>
    <button onclick="register()">è¨»å†Š</button>
    <p>å·²æœ‰å¸³è™Ÿï¼Ÿ<a href="#" onclick="openLogin()">ç™»å…¥</a></p>
  </div>
</div>

<div class="hero">
  <h1>ç¾é£Ÿæ¨è–¦å™¨</h1>
</div>

<header>
  <a href="#" onclick="showSection('random')">éš¨æ©ŸæŠ½é¸</a>
  <a href="#" onclick="showSection('filter')">åˆ†é¡ç¯©é¸</a>
  <a href="#" onclick="showSection('custom')">è¼¸å…¥éœ€æ±‚</a>
  <a href="#" onclick="showSection('comment')">ç¶²å‹ç•™è¨€å€</a>
</header>

<!-- ======================
      éš¨æ©ŸæŠ½é¸
======================= -->
<section id="random" class="active">
  <h2>ğŸ² éš¨æ©ŸæŠ½é¸</h2>
  <form id="randomForm">

    <label>åŸå¸‚ï¼š
      <select id="citySelect" onchange="updateDistricts()">
        <option value="">è«‹é¸æ“‡åŸå¸‚</option>
        <option value="keelung">åŸºéš†å¸‚</option>
        <option value="newtaipei">æ–°åŒ—å¸‚</option>
        <option value="taipei">å°åŒ—å¸‚</option>
        <option value="taoyuan">æ¡ƒåœ’å¸‚</option>
        <option value="hsinchucity">æ–°ç«¹å¸‚</option>
        <option value="hsinchucounty">æ–°ç«¹ç¸£</option>
        <option value="yilan">å®œè˜­ç¸£</option>
        <option value="miaoli">è‹—æ —ç¸£</option>
        <option value="taichung">å°ä¸­å¸‚</option>
        <option value="changhua">å½°åŒ–ç¸£</option>
        <option value="nantou">å—æŠ•ç¸£</option>
        <option value="yunlin">é›²æ—ç¸£</option>
        <option value="chiayicity">å˜‰ç¾©å¸‚</option>
        <option value="chiayicounty">å˜‰ç¾©ç¸£</option>
        <option value="tainan">å°å—å¸‚</option>
        <option value="kaohsiung">é«˜é›„å¸‚</option>
        <option value="pingtung">å±æ±ç¸£</option>
        <option value="hualien">èŠ±è“®ç¸£</option>
        <option value="taitung">å°æ±ç¸£</option>
        <option value="penghu">æ¾æ¹–ç¸£</option>
        <option value="kinmen">é‡‘é–€ç¸£</option>
        <option value="lienchiang">é€£æ±Ÿç¸£</option>
      </select>
    </label>

    <label>å€åŸŸï¼š
      <select id="districtSelect">
        <option value="">è«‹å…ˆé¸æ“‡åŸå¸‚</option>
      </select>
    </label>

    <label>ä¸»é£Ÿé¡å‹ï¼š
      <select id="mainType" onchange="checkOtherType()">
        <option value="">è«‹é¸æ“‡</option>
        <option value="é£¯">é£¯</option>
        <option value="éºµ">éºµ</option>
        <option value="ç”œé»">ç”œé»</option>
        <option value="é£²æ–™">é£²æ–™</option>
        <option value="å…¶ä»–">å…¶ä»–</option>
      </select>
    </label>

    <label id="otherInputLabel" style="display:none;">
      è‡ªå®šç¾©ä¸»é£Ÿé¡å‹ï¼š
      <input type="text" id="otherInput" placeholder="ä¾‹å¦‚ï¼šå£½å¸ã€ç‡’è‚‰ã€æ—©åˆé¤â€¦">
    </label>

    <label>å£å‘³ï¼š</label>
    <div class="checkbox-group" id="tasteChecks">
      <label><input type="checkbox" value="é¹¹">é¹¹</label>
      <label><input type="checkbox" value="ç”œ">ç”œ</label>
      <label><input type="checkbox" value="è¾£">è¾£</label>
      <label><input type="checkbox" value="é…¸">é…¸</label>
    </div>

    <label>åƒ¹ä½ï¼š</label>
    <div class="checkbox-group" id="priceChecks">
      <label><input type="checkbox" value="ä¾¿å®œ">ä¾¿å®œ</label>
      <label><input type="checkbox"value="ä¸­ç­‰">ä¸­ç­‰</label>
      <label><input type="checkbox"value="é«˜ç´š">é«˜ç´š</label>
    </div>

    <button type="button" onclick="randomRecommend()">é–‹å§‹éš¨æ©Ÿæ¨è–¦ï¼</button>
  </form>

  <div id="recommendation"></div>
  <div id="map"></div>
</section>

<!-- ======================
      åˆ†é¡ç¯©é¸
======================= -->
<section id="filter">
  <h2>ğŸ± åˆ†é¡ç¯©é¸</h2>

  <div class="category-buttons">
    <button onclick="filterCategory('é«˜CPå€¼')">é«˜CPå€¼</button>
    <button onclick="filterCategory('ç´„æœƒé¤å»³')">ç´„æœƒé¤å»³</button>
    <button onclick="filterCategory('å¤šäººèšæœƒ')">å¤šäººèšæœƒ</button>
    <button onclick="filterCategory('ç”œé»ä¸‹åˆèŒ¶')">ç”œé»ä¸‹åˆèŒ¶</button>
    <button onclick="filterCategory('å¤œè²“å­')">å¤œè²“å­</button>
    <button onclick="filterCategory('è¶•æ™‚é–“')">è¶•æ™‚é–“</button>
    <button onclick="filterCategory('å¤–å¸¶å¤–é€å‹å–„')">å¤–å¸¶å¤–é€å‹å–„</button>
    <button onclick="filterCategory('ä¸‹é›¨å¤©')">ä¸‹é›¨å¤©</button>
  </div>

  <ul id="restaurantList"></ul>
  <div id="mapFilter"></div>
</section>

<!-- ======================
      è¼¸å…¥éœ€æ±‚
======================= -->
<section id="custom">
  <h2>ğŸ” è¼¸å…¥éœ€æ±‚</h2>

  <label>åŸå¸‚ï¼š
    <select id="customCity" onchange="updateCustomDistricts()">
      <option value="">è«‹é¸æ“‡åŸå¸‚</option>
      <option value="keelung">åŸºéš†å¸‚</option>
      <option value="newtaipei">æ–°åŒ—å¸‚</option>
      <option value="taipei">å°åŒ—å¸‚</option>
      <option value="taoyuan">æ¡ƒåœ’å¸‚</option>
      <option value="hsinchucity">æ–°ç«¹å¸‚</option>
      <option value="hsinchucounty">æ–°ç«¹ç¸£</option>
      <option value="yilan">å®œè˜­ç¸£</option>
      <option value="miaoli">è‹—æ —ç¸£</option>
      <option value="taichung">å°ä¸­å¸‚</option>
      <option value="changhua">å½°åŒ–ç¸£</option>
      <option value="nantou">å—æŠ•ç¸£</option>
      <option value="yunlin">é›²æ—ç¸£</option>
      <option value="chiayicity">å˜‰ç¾©å¸‚</option>
      <option value="chiayicounty">å˜‰ç¾©ç¸£</option>
      <option value="tainan">å°å—å¸‚</option>
      <option value="kaohsiung">é«˜é›„å¸‚</option>
      <option value="pingtung">å±æ±ç¸£</option>
      <option value="hualien">èŠ±è“®ç¸£</option>
      <option value="taitung">å°æ±ç¸£</option>
      <option value="penghu">æ¾æ¹–ç¸£</option>
      <option value="kinmen">é‡‘é–€ç¸£</option>
      <option value="lienchiang">é€£æ±Ÿç¸£</option>
    </select>
  </label>

  <label>å€åŸŸï¼š
    <select id="customDistrict">
      <option value="">è«‹å…ˆé¸æ“‡åŸå¸‚</option>
    </select>
  </label>

  <label>è«‹è¼¸å…¥æ‚¨çš„éœ€æ±‚ï¼ˆä¾‹ï¼šæˆ‘æƒ³åƒæ‹‰éºµã€æƒ³æ‰¾ç´„æœƒé¤å»³â€¦ï¼‰ï¼š
    <input id="freeText" type="text" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³åƒä¾¿å®œæ‹‰éºµ">
  </label>

  <button onclick="customSearch()">é€å‡ºæœå°‹</button>

  <div id="customResults"></div>
  <div id="mapCustom"></div>
</section>

<!-- ======================
      ç¶²å‹ç•™è¨€å€
======================= -->
<section id="comment">
  <h2>ç¶²å‹ç•™è¨€å€</h2>

  <!-- ğŸ” æœå°‹é¤å»³ -->
    <div id="searchArea">
      <input type="text" id="searchRestaurant" placeholder="è¼¸å…¥é¤å»³åç¨±ï¼Œä¾‹å¦‚ï¼šé˜¿å®—éºµç·š">
      <button id="searchBtn">æœå°‹è©•è«–</button>
    </div>

    <!-- âœï¸ ç•™è¨€è¼¸å…¥å€ -->
    <div id="reviewArea" style="display:none;">
      <h3 id="currentRestaurant" style="text-align:center; color:#ff8c42;"></h3>

      <div class="rating-group">
        <div class="rating-row">
          <span>å£å‘³ï¼š</span><div class="stars" data-category="taste">â˜…â˜…â˜…â˜…â˜…</div>
        </div>
        <div class="rating-row">
          <span>æœå‹™ï¼š</span><div class="stars" data-category="service">â˜…â˜…â˜…â˜…â˜…</div>
        </div>
        <div class="rating-row">
          <span>ç’°å¢ƒï¼š</span><div class="stars" data-category="environment">â˜…â˜…â˜…â˜…â˜…</div>
        </div>
        <div class="rating-row">
          <span>åƒ¹ä½ï¼š</span><div class="stars" data-category="price">â˜…â˜…â˜…â˜…â˜…</div>
        </div>
      </div>

      <textarea id="commentInput" placeholder="è¼¸å…¥æ‚¨çš„ç”¨é¤å¿ƒå¾—..."></textarea>
      <button id="submitReview">é€å‡ºè©•è«–</button>

      <!-- ğŸ’¬ è©•è«–åˆ—è¡¨ -->
      <div id="reviewList">
        <h3>ğŸŠ ç¶²å‹ç•™è¨€</h3>
        <ul id="reviewsUl"></ul>
      </div>
    </div>
</section>

<!-- ======================
      æ”¶è—å´æ¬„
======================= -->
<button id="toggleFavorites">â˜° æ”¶è—</button>

<div id="favoriteSidebar">
  <h3>æˆ‘çš„æ”¶è—</h3>
  <ul id="favoritesUl"></ul>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ===================== CONFIG ===================== */
async function postAPI(payload) {
  try {
    const res = await fetch("https://food123-lhfa.onrender.com/gemini", { //å‘¼å«proxy server
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      mode: 'cors',
      body: JSON.stringify(payload)
    });
    const data = await res.text(); //å›å‚³jsonç‰©ä»¶
    return JSON.parse(data);
  } catch (err) {
    console.error('postAPI error', err);
    return { ok: false, error: err.message || String(err) };
  }
}

/* ===================== åœ°åœ–åˆå§‹åŒ–ï¼ˆLeafletï¼‰ ===================== */
const defaultCenter = [25.033, 121.565]; // å°åŒ—ä¸­å¿ƒä½œç‚ºé è¨­
let map = L.map('map').setView(defaultCenter, 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let mapFilter = L.map('mapFilter').setView(defaultCenter, 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(mapFilter);

let mapCustom = L.map('mapCustom').setView(defaultCenter, 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(mapCustom);

/* marker holders */
let singleMarker = null;
let filterMarkers = [];
let customMarkers = [];

/* -------------------- UI helpers -------------------- */
function showSection(id){
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
}

/* -------------------- city/district data & helpers -------------------- */
const districts = {
      keelung: ['ä»æ„›å€', 'ä¿¡ç¾©å€', 'ä¸­æ­£å€', 'ä¸­å±±å€', 'å®‰æ¨‚å€', 'æš–æš–å€', 'ä¸ƒå µå€'],
      taipei: ['åŒ—æŠ•å€', 'å£«æ—å€', 'ä¸­å±±å€', 'å…§æ¹–å€', 'å¤§åŒå€', 'æ¾å±±å€', 'å¤§å®‰å€', 'ä¿¡ç¾©å€', 'å—æ¸¯å€', 'ä¸­æ­£å€', 'è¬è¯å€', 'æ–‡å±±å€'],
      newtaipei: ['æ¿æ©‹å€', 'æ–°èŠå€', 'ä¸­å’Œå€', 'æ°¸å’Œå€', 'åœŸåŸå€', 'æ¨¹æ—å€', 'ä¸‰å³½å€', 'é¶¯æ­Œå€', 'ä¸‰é‡å€', 'è˜†æ´²å€', 'äº”è‚¡å€', 'æ³°å±±å€',
                'æ—å£å€', 'å…«é‡Œå€', 'æ·¡æ°´å€', 'ä¸‰èŠå€', 'çŸ³é–€å€', 'é‡‘å±±å€', 'è¬é‡Œå€', 'æ±æ­¢å€', 'ç‘èŠ³å€', 'è²¢å¯®å€', 'å¹³æºªå€', 'é›™æºªå€', 'æ–°åº—å€',
                'æ·±å‘å€', 'çŸ³ç¢‡å€', 'åªæ—å€', 'çƒä¾†å€'],
      taoyuan: ['æ¡ƒåœ’å€', 'ä¸­å£¢å€', 'å¹³é®å€', 'å…«å¾·å€', 'æ¥Šæ¢…å€', 'è˜†ç«¹å€', 'å¤§æºªå€', 'é¾æ½­å€', 'é¾œå±±å€', 'å¤§åœ’å€', 'è§€éŸ³å€', 'æ–°å±‹å€', 'å¾©èˆˆå€'],
      hsinchucity: ['æ±å€', 'åŒ—å€', 'é¦™å±±å€'],
      hsinchucounty: ['ç«¹åŒ—å¸‚', 'ç«¹æ±é®', 'æ–°åŸ”é®', 'é—œè¥¿é®', 'æ¹–å£é„‰', 'æ–°è±é„‰', 'èŠæ—é„‰', 'æ©«å±±é„‰', 'åŒ—åŸ”é„‰', 'å¯¶å±±é„‰', 'å³¨çœ‰é„‰', 'å°–çŸ³é„‰', 'äº”å³°é„‰'],
      yilan: ['å®œè˜­å¸‚', 'ç¾…æ±é®', 'è˜‡æ¾³é®', 'é ­åŸé®', 'ç¤æºªé„‰', 'å£¯åœé„‰', 'å“¡å±±é„‰', 'å†¬å±±é„‰', 'äº”çµé„‰', 'ä¸‰æ˜Ÿé„‰', 'å¤§åŒé„‰', 'å—æ¾³é„‰'],
      miaoli: ['è‹—æ —å¸‚', 'é ­ä»½å¸‚', 'è‹‘è£¡é®', 'é€šéœ„é®', 'ç«¹å—é®', 'å¾Œé¾é®', 'å“è˜­é®', 'å¤§æ¹–é„‰', 'å…¬é¤¨é„‰', 'éŠ…é‘¼é„‰', 'å—åº„é„‰', 'é ­å±‹é„‰', 'ä¸‰ç¾©é„‰', 'è¥¿æ¹–é„‰', 'é€ æ©‹é„‰', 'ä¸‰ç£é„‰', 'ç…æ½­é„‰', 'æ³°å®‰é„‰'],
      taichung: ['ä¸­å€', 'æ±å€', 'å—å€', 'è¥¿å€', 'åŒ—å€', 'åŒ—å±¯å€', 'è¥¿å±¯å€', 'å—å±¯å€', 'å¤ªå¹³å€', 'å¤§é‡Œå€', 'éœ§å³°å€', 'çƒæ—¥å€', 'è±åŸå€', 'åé‡Œå€', 'çŸ³å²¡å€',
                 'æ±å‹¢å€', 'å’Œå¹³å€', 'æ–°ç¤¾å€', 'æ½­å­å€', 'å¤§é›…å€', 'ç¥å²¡å€', 'å¤§è‚šå€', 'æ²™é¹¿å€', 'é¾äº•å€', 'æ¢§æ£²å€', 'æ¸…æ°´å€', 'å¤§ç”²å€', 'å¤–åŸ”å€', 'å¤§å®‰å€'],
      changhua: ['å½°åŒ–å¸‚', 'å“¡æ—å¸‚', 'å’Œç¾é®', 'é¹¿æ¸¯é®', 'æºªæ¹–é®', 'äºŒæ—é®', 'ç”°ä¸­é®', 'åŒ—æ–—é®', 'èŠ±å£‡é„‰', 'èŠ¬åœ’é„‰', 'å¤§æ‘é„‰', 'æ°¸é–é„‰', 'ä¼¸æ¸¯é„‰', 'ç·šè¥¿é„‰',
                 'ç¦èˆˆé„‰', 'ç§€æ°´é„‰', 'åŸ”å¿ƒé„‰', 'åŸ”é¹½é„‰', 'å¤§åŸé„‰', 'ç«¹å¡˜é„‰', 'æºªå·é„‰', 'ç”°å°¾é„‰', 'åŸ¤é ­é„‰', 'èŠ³è‹‘é„‰', 'ç¤¾é ­é„‰', 'äºŒæ°´é„‰'],
      nantou: ['å—æŠ•å¸‚', 'åŸ”é‡Œé®', 'è‰å±¯é®', 'ç«¹å±±é®', 'é›†é›†é®', 'åé–“é„‰', 'é¹¿è°·é„‰', 'ä¸­å¯®é„‰', 'é­šæ± é„‰', 'åœ‹å§“é„‰', 'æ°´é‡Œé„‰', 'ä¿¡ç¾©é„‰', 'ä»æ„›é„‰'],
      yunlin: ['æ–—å…­å¸‚', 'æ–—å—é®', 'è™å°¾é®', 'è¥¿èºé®', 'åœŸåº«é®', 'åŒ—æ¸¯é®', 'è¿æ¡é„‰', 'æ—å…§é„‰', 'å¤å‘é„‰', 'å¤§åŸ¤é„‰', 'äºŒå´™é„‰', 'å´™èƒŒé„‰', 'éº¥å¯®é„‰', 'æ±å‹¢é„‰', 'è¤’å¿ é„‰', 'å°è¥¿é„‰', 'å…ƒé•·é„‰', 'å››æ¹–é„‰', 'å£æ¹–é„‰', 'æ°´æ—é„‰'],
      chiayicity: ['æ±å€', 'è¥¿å€'],
      chiayicounty: ['å¤ªä¿å¸‚', 'æœ´å­å¸‚', 'å¸ƒè¢‹é®', 'å¤§æ—é®', 'æ°‘é›„é„‰', 'æºªå£é„‰', 'æ–°æ¸¯é„‰', 'å…­è…³é„‰', 'æ±çŸ³é„‰', 'ç¾©ç«¹é„‰', 'é¹¿è‰é„‰', 'æ°´ä¸Šé„‰', 'ä¸­åŸ”é„‰', 'ç«¹å´é„‰', 'æ¢…å±±é„‰', 'ç•ªè·¯é„‰', 'å¤§åŸ”é„‰', 'é˜¿é‡Œå±±é„‰'],
      tainan: ['ä¸­è¥¿å€', 'æ±å€', 'å—å€', 'åŒ—å€', 'å®‰å¹³å€', 'å®‰å—å€', 'æ°¸åº·å€', 'æ­¸ä»å€', 'æ–°åŒ–å€', 'å·¦é®å€', 'ç‰äº•å€', 'æ¥ è¥¿å€', 'å—åŒ–å€', 'ä»å¾·å€', 'é—œå»Ÿå€',
             'é¾å´å€', 'å®˜ç”°å€', 'éº»è±†å€', 'ä½³é‡Œå€', 'è¥¿æ¸¯å€', 'ä¸ƒè‚¡å€', 'å°‡è»å€', 'å­¸ç”²å€', 'åŒ—é–€å€', 'æ–°ç‡Ÿå€', 'å¾Œå£å€', 'ç™½æ²³å€', 'æ±å±±å€', 'å…­ç”²å€', 'ä¸‹ç‡Ÿå€',
              'æŸ³ç‡Ÿå€', 'é¹½æ°´å€', 'å–„åŒ–å€', 'å¤§å…§å€', 'å±±ä¸Šå€', 'æ–°å¸‚å€', 'å®‰å®šå€'],
      kaohsiung: ['æ–°èˆˆå€', 'å‰é‡‘å€', 'è‹“é›…å€', 'é¹½åŸ•å€', 'é¼“å±±å€', 'æ——æ´¥å€', 'å‰é®å€', 'ä¸‰æ°‘å€', 'æ¥ æ¢“å€', 'å°æ¸¯å€', 'å·¦ç‡Ÿå€', 'ä»æ­¦å€', 'å¤§ç¤¾å€', 'å²¡å±±å€', 'è·¯ç«¹å€',
                'é˜¿è“®å€', 'ç”°å¯®å€', 'ç‡•å·¢å€', 'æ©‹é ­å€', 'æ¢“å®˜å€', 'å½Œé™€å€', 'æ°¸å®‰å€', 'æ¹–å…§å€', 'é³³å±±å€', 'å¤§å¯®å€', 'æ—åœ’å€', 'é³¥æ¾å€', 'å¤§æ¨¹å€', 'æ——å±±å€', 'ç¾æ¿ƒå€', 'å…­é¾œå€',
                 'å…§é–€å€', 'æ‰æ—å€', 'ç”²ä»™å€', 'æ¡ƒæºå€', 'é‚£ç‘ªå¤å€', 'èŒ‚æ—å€', 'èŒ„è£å€'],
      pingtung: ['å±æ±å¸‚', 'æ½®å·é®', 'æ±æ¸¯é®', 'æ†æ˜¥é®', 'è¬ä¸¹é„‰', 'é•·æ²»é„‰', 'éºŸæ´›é„‰', 'ä¹å¦‚é„‰', 'é‡Œæ¸¯é„‰', 'é¹½åŸ”é„‰', 'é«˜æ¨¹é„‰', 'è¬å·’é„‰', 'å…§åŸ”é„‰', 'ç«¹ç”°é„‰', 'æ–°åŸ¤é„‰', 'æ‹å¯®é„‰',
                 'æ‹å±±é„‰', 'æ˜¥æ—¥é„‰', 'ç…å­é„‰', 'è»ŠåŸé„‰', 'ç‰¡ä¸¹é„‰', 'æ†æ˜¥é„‰', 'æ»¿å·é„‰', 'ä¸‰åœ°é–€é„‰', 'éœ§å°é„‰', 'ç‘ªå®¶é„‰', 'æ³°æ­¦é„‰', 'ä¾†ç¾©é„‰', 'å—å·é„‰', 'ä½³å†¬é„‰', 'æ—é‚Šé„‰', 'æ±æ¸¯é„‰', 'ç‰çƒé„‰', 'æ‹å±±é„‰', 'è»ŠåŸé„‰'],
      hualien: ['èŠ±è“®å¸‚', 'ç‰é‡Œé®', 'æ–°åŸé„‰', 'å‰å®‰é„‰', 'å£½è±é„‰', 'é³³æ—é®', 'å…‰å¾©é„‰', 'è±æ¿±é„‰', 'ç‘ç©—é„‰', 'è¬æ¦®é„‰', 'å¯Œé‡Œé„‰', 'å“æºªé„‰'],
      taitung: ['å°æ±å¸‚', 'æˆåŠŸé®', 'é—œå±±é®', 'é•·æ¿±é„‰', 'æµ·ç«¯é„‰', 'æ± ä¸Šé„‰', 'æ±æ²³é„‰', 'é¹¿é‡é„‰', 'å»¶å¹³é„‰', 'å‘å—é„‰', 'é‡‘å³°é„‰', 'å¤§æ­¦é„‰', 'é”ä»é„‰', 'ç¶ å³¶é„‰', 'è˜­å¶¼é„‰', 'å¤ªéº»é‡Œé„‰'],
      penghu: ['é¦¬å…¬å¸‚', 'æ¹–è¥¿é„‰', 'ç™½æ²™é„‰', 'è¥¿å¶¼é„‰', 'æœ›å®‰é„‰', 'ä¸ƒç¾é„‰'],
      kinmen: ['é‡‘æ²™é®', 'é‡‘æ¹–é®', 'é‡‘å¯§é„‰', 'é‡‘åŸé®', 'çƒˆå¶¼é„‰', 'çƒåµé„‰'],
      lienchiang: ['å—ç«¿é„‰', 'åŒ—ç«¿é„‰', 'è’å…‰é„‰', 'æ±å¼•é„‰']
    };

function updateDistricts(){
  const city = document.getElementById('citySelect').value;
  const sel = document.getElementById('districtSelect');
  sel.innerHTML = '<option value="">å…¨éƒ¨</option>';
  if (city && districts[city]) {
    districts[city].forEach(d => {
      const o = document.createElement('option'); o.value = d; o.textContent = d; sel.appendChild(o);
    });
  } else {
    sel.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡åŸå¸‚</option>';
  }
}
function updateCustomDistricts(){
  const city = document.getElementById('customCity').value;
  const sel = document.getElementById('customDistrict');
  sel.innerHTML = '<option value="">å…¨éƒ¨</option>';
  if (city && districts[city]) {
    districts[city].forEach(d => {
      const o = document.createElement('option'); o.value = d; o.textContent = d; sel.appendChild(o);
    });
  } else {
    sel.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡åŸå¸‚</option>';
  }
}
function checkOtherType(){
  const main = document.getElementById('mainType').value;
  document.getElementById('otherInputLabel').style.display = main === 'å…¶ä»–' ? 'block' : 'none';
}

/* ===================== Authentication & Favorites ===================== */
let loggedIn = false;
let currentUser = null;
let users = {}; // æ¨¡æ“¬å¸³è™Ÿè³‡æ–™åº«
let userFavorites = {}; // ä½¿ç”¨è€…æ”¶è—

const loginBtn = document.getElementById('loginBtn');
const registerBtn = document.getElementById('registerBtn');
const welcomeText = document.getElementById('welcomeText');

// Modal é–‹é—œå‡½å¼
function openLogin() { document.getElementById("loginModal").style.display="flex"; document.getElementById("registerModal").style.display="none";}
function openRegister() { document.getElementById("registerModal").style.display="flex"; document.getElementById("loginModal").style.display="none";}
function closeLoginModal() { document.getElementById("loginModal").style.display="none";}
function closeRegisterModal() { document.getElementById("registerModal").style.display="none";}
function clickOutside(event, modalId) { if(event.target.id===modalId) document.getElementById(modalId).style.display="none"; }

// è¨»å†ŠåŠŸèƒ½
function register() {
  const u = document.getElementById("registerUsername").value.trim();
  const p = document.getElementById("registerPassword").value;
  const p2 = document.getElementById("registerPasswordConfirm").value;
  if(!u||!p) return alert("è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼");
  if(p!==p2) return alert("å¯†ç¢¼ä¸ä¸€è‡´");
  if(users[u]) return alert("å¸³è™Ÿå·²å­˜åœ¨");
  users[u]=p;
  userFavorites[u]=[];
  alert("è¨»å†ŠæˆåŠŸï¼");
  closeRegisterModal();
  openLogin();
}

// ç™»å…¥åŠŸèƒ½
function login() {
  const u = document.getElementById("loginUsername").value.trim();
  const p = document.getElementById("loginPassword").value;
  if(!u||!p) return alert("è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼");
  if(users[u] && users[u]===p){
    loggedIn=true;
    currentUser=u;
    welcomeText.textContent=`æ‚¨å¥½, ${u}`;
    loginBtn.textContent="ç™»å‡º";
    closeLoginModal();
  } else { alert("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤"); }
}

// ç™»å‡ºæŒ‰éˆ•
loginBtn.onclick = () => {
  if(!loggedIn) openLogin();
  else {
    loggedIn=false;
    currentUser=null;
    welcomeText.textContent="æœªç™»å…¥";
    loginBtn.textContent="ç™»å…¥";
    alert("å·²ç™»å‡º");
  }
};
registerBtn.onclick=openRegister;

async function addToFavorites(place) {
  if (!loggedIn) return alert('è«‹å…ˆç™»å…¥æ‰èƒ½æ”¶è—');
  const resp = await postAPI({ action: 'addFavorite', username: currentUser, place });
  if (resp && resp.ok) {
    alert('å·²åŠ å…¥æ”¶è—');
    loadFavoritesForCurrentUser();
  } else {
    alert('åŠ å…¥æ”¶è—å¤±æ•—ï¼š' + (resp.error || JSON.stringify(resp)));
  }
}

async function loadFavoritesForCurrentUser() {
  if (!loggedIn) return;
  const resp = await postAPI({ action: 'getFavorites', username: currentUser });
  const ul = document.getElementById('favoritesUl');
  ul.innerHTML = '';
  if (resp && resp.ok && Array.isArray(resp.favorites)) {
    resp.favorites.forEach(f => {
      const li = document.createElement('li');
      li.innerHTML = `<span>${f.name} â€” ${f.address || ''}</span>
                      <button style="margin-left:8px" onclick='removeFavorite("${f.name.replace(/"/g,"\\\"")}")'>ç§»é™¤</button>`;
      ul.appendChild(li);
    });
  }
}

async function removeFavorite(name) {
  if (!loggedIn) return alert('è«‹å…ˆç™»å…¥');
  const resp = await postAPI({ action: 'removeFavorite', username: currentUser, name });
  if (resp && resp.ok) {
    loadFavoritesForCurrentUser();
  } else {
    alert('åˆªé™¤å¤±æ•—');
  }
}

/* ===================== éš¨æ©ŸæŠ½é¸ï¼ˆå‘¼å« Gemin i via backend recommendï¼‰ ===================== */
async function randomRecommend() {
  // æ”¶é›†æ¢ä»¶
  const city = document.getElementById('citySelect').value;
  const district = document.getElementById('districtSelect').value;
  const mainType = document.getElementById('mainType').value;
  const otherType = document.getElementById('otherInput').value;
  const tastes = Array.from(document.querySelectorAll('#tasteChecks input[type=checkbox]:checked')).map(i=>i.value);
  const prices = Array.from(document.querySelectorAll('#priceChecks input[type=checkbox]:checked')).map(i=>i.value);

  const queryType = mainType === 'å…¶ä»–' && otherType ? otherType : (mainType || '');

  const options = {
    mode: 'random',
    city, district,
    mainType: queryType,
    tastes, prices
  };

  // UI
  const recDiv = document.getElementById('recommendation');
  recDiv.innerHTML = 'è«‹ç¨å€™ï¼Œæ­£åœ¨ä½¿ç”¨ Gemini ç”Ÿæˆæ¨è–¦...';

  const resp = await postAPI({ action: 'recommend', options });
  if (!resp || !resp.ok) {
    recDiv.innerHTML = 'æ¨è–¦å¤±æ•—ï¼š' + (resp ? (resp.error || JSON.stringify(resp)) : 'ç„¡å›æ‡‰');
    return;
  }

  const list = resp.restaurants;
  if (!Array.isArray(list) || list.length === 0) {
    recDiv.innerHTML = 'æ²’æœ‰çµæœ';
    return;
  }

  // å¾ç”Ÿæˆæ¸…å–®ä¸­éš¨æ©ŸæŒ‘ä¸€é–“é¡¯ç¤ºã€ä¸¦åœ¨åœ°åœ–ä¸Šæ¨™è¨˜
  const choice = list[Math.floor(Math.random()*list.length)];
  renderSingleRecommendation(choice);
}

/* é¡¯ç¤ºå–®ä¸€æ¨è–¦ (random) */
function renderSingleRecommendation(choice) {
  const recDiv = document.getElementById('recommendation');
  recDiv.innerHTML = '';
  if (!choice) { recDiv.innerHTML = 'æ²’æœ‰æ¨è–¦'; return; }
  const title = document.createElement('h3'); title.textContent = choice.name || 'Unnamed';
  const p = document.createElement('p'); p.innerHTML = `${choice.address || ''} ${choice.price ? 'ï½œ' + choice.price : ''}<br>${choice.reason || ''}`;
  const favBtn = document.createElement('button'); favBtn.textContent = 'â˜… æ”¶è—'; favBtn.onclick = () => addToFavorites({
    name: choice.name, address: choice.address, lat: choice.lat, lng: choice.lng
  });

  recDiv.appendChild(title); recDiv.appendChild(p); recDiv.appendChild(favBtn);

  // map
  if (singleMarker) {
    map.removeLayer(singleMarker);
    singleMarker = null;
  }
  if (choice.lat && choice.lng) {
    singleMarker = L.marker([choice.lat, choice.lng]).addTo(map).bindPopup(`<b>${choice.name}</b><br>${choice.address || ''}`).openPopup();
    map.setView([choice.lat, choice.lng], 15);
  } else {
    // å¦‚æœæ²’æœ‰åº§æ¨™ï¼Œå˜—è©¦ä¸æ”¹è®Šåœ°åœ–ä¸¦é¡¯ç¤ºæç¤º
    map.setView(defaultCenter, 12);
  }
}

/* ===================== åˆ†é¡ç¯©é¸ï¼ˆé¡¯ç¤ºå¤šç­†ï¼‰ ===================== */
async function filterCategory(category) {
  const city = document.getElementById('citySelect').value;
  const district = document.getElementById('districtSelect').value;
  const options = { mode: 'category', category, city, district };

  const listDiv = document.getElementById('restaurantList');
  listDiv.innerHTML = 'æœå°‹ä¸­ï¼ˆç”± Gemini ç”Ÿæˆï¼‰...';

  const resp = await postAPI({ action: 'recommend', options });
  if (!resp || !resp.ok) {
    listDiv.innerHTML = 'æœå°‹å¤±æ•—ï¼š' + (resp ? (resp.error || JSON.stringify(resp)) : 'ç„¡å›æ‡‰');
    return;
  }
  const list = resp.restaurants || [];
  listDiv.innerHTML = '';

  // æ¸…é™¤åŸæœ¬ markers
  filterMarkers.forEach(m => mapFilter.removeLayer(m));
  filterMarkers = [];

  if (list.length === 0) {
    listDiv.innerHTML = '<li>ç„¡çµæœ</li>';
    return;
  }

  list.forEach(p => {
    const li = document.createElement('li');
    li.innerHTML = `<span style="display:block">${p.name} ${p.price ? 'ï½œ' + p.price : ''} <br><small>${p.address || ''}</small></span>
                    <button style="margin-left:8px">æ”¶è—</button>`;
    // button onclick
    const btn = li.querySelector('button');
    btn.onclick = () => addToFavorites({ name: p.name, address: p.address, lat: p.lat, lng: p.lng });

    listDiv.appendChild(li);

    if (p.lat && p.lng) {
      const m = L.marker([p.lat, p.lng]).addTo(mapFilter).bindPopup(`<b>${p.name}</b><br>${p.address || ''}`);
      filterMarkers.push(m);
    }
  });

  // èšç„¦åˆ°ç¬¬ä¸€å€‹æœ‰åº§æ¨™çš„é»
  const first = list.find(x => x.lat && x.lng);
  if (first) mapFilter.setView([first.lat, first.lng], 13);
}

/* ===================== è‡ªè¨‚éœ€æ±‚ï¼ˆfree textï¼‰ ===================== */
async function customSearch() {
  const city = document.getElementById('customCity').value;
  const district = document.getElementById('customDistrict').value;
  const freeText = document.getElementById('freeText').value.trim();
  if (!freeText) return alert('è«‹è¼¸å…¥éœ€æ±‚');

  const options = { mode: 'custom', city, district, query: freeText };

  const resultsDiv = document.getElementById('customResults');
  resultsDiv.innerHTML = 'æœå°‹ä¸­ï¼ˆç”± Gemini ç”Ÿæˆï¼‰...';

  const resp = await postAPI({ action: 'recommend', options });
  if (!resp || !resp.ok) {
    resultsDiv.innerHTML = 'æœå°‹å¤±æ•—ï¼š' + (resp ? (resp.error || JSON.stringify(resp)) : 'ç„¡å›æ‡‰');
    return;
  }

  const list = resp.restaurants || [];
  resultsDiv.innerHTML = '';

  // æ¸…æ‰ custom markers
  customMarkers.forEach(m => mapCustom.removeLayer(m));
  customMarkers = [];

  if (list.length === 0) {
    resultsDiv.innerHTML = '<div>ç„¡çµæœ</div>';
    return;
  }

  list.forEach(p => {
    const el = document.createElement('div');
    el.style.borderBottom = '1px solid #f4c095';
    el.style.padding = '8px 0';
    el.innerHTML = `<strong>${p.name}</strong><div>${p.address || ''}</div><div style="font-size:0.9rem;">${p.reason || ''}</div>
                    <button style="margin-top:6px">æ”¶è—</button>`;
    const btn = el.querySelector('button');
    btn.onclick = () => addToFavorites({ name: p.name, address: p.address, lat: p.lat, lng: p.lng });
    resultsDiv.appendChild(el);

    if (p.lat && p.lng) {
      const m = L.marker([p.lat, p.lng]).addTo(mapCustom).bindPopup(`<b>${p.name}</b><br>${p.address || ''}`);
      customMarkers.push(m);
    }
  });

  const first = list.find(x => x.lat && x.lng);
  if (first) mapCustom.setView([first.lat, first.lng], 13);
}

// ===== æœå°‹é¤å»³ =====
const searchBtn = document.getElementById("searchBtn");
const reviewArea = document.getElementById("reviewArea");
const currentRestaurant = document.getElementById("currentRestaurant");
const reviewsUl = document.getElementById("reviewsUl");

searchBtn.onclick = () => {
  const restaurantName = document.getElementById("searchRestaurant").value.trim();
  if (!restaurantName) return alert("è«‹è¼¸å…¥é¤å»³åç¨±");

  currentRestaurant.innerText = restaurantName;
  reviewArea.style.display = "block";

  const reviews = JSON.parse(localStorage.getItem(restaurantName)) || [];
  renderReviews(reviews, restaurantName);

  // é‡ç½®æ˜Ÿæ˜Ÿé¡¯ç¤º
  document.querySelectorAll(".stars").forEach(starDiv => {
    starDiv.innerHTML = "â˜…â˜…â˜…â˜…â˜…".split("").map((_, i) => `<span data-index="${i}">â˜…</span>`).join("");
  });
  document.getElementById("commentInput").value = "";
  initStarClicks();
};

// ===== åˆå§‹åŒ–æ˜Ÿæ˜Ÿé»æ“Šäº‹ä»¶ =====
function initStarClicks() {
  document.querySelectorAll(".stars").forEach(starDiv => {
    const spans = starDiv.querySelectorAll("span");

    // åˆå§‹åŒ–é¡è‰²ç‚ºç°è‰²
    spans.forEach(s => s.style.color = "lightgray");

    spans.forEach(span => {
      span.onclick = () => {
        const index = parseInt(span.dataset.index); // å–å¾—é»æ“Šçš„æ˜Ÿæ˜Ÿä½ç½®
        spans.forEach((s, i) => {
          s.style.color = i <= index ? "gold" : "lightgray"; // å·¦é‚ŠåŠè‡ªå·±é»ƒé‡‘è‰²ï¼Œå³é‚Šç°è‰²
        });
      };
    });
  });
}

// ===== æ¸²æŸ“ç•™è¨€åˆ—è¡¨ =====
function renderReviews(reviews, restaurantName) {
  reviewsUl.innerHTML = "";
  reviews.forEach((r, index) => {
    const li = document.createElement("li");
    li.innerHTML = `<strong>${r.username}</strong> (å£å‘³:${r.rating.taste}â­ / æœå‹™:${r.rating.service}â­ / ç’°å¢ƒ:${r.rating.environment}â­ / åƒ¹ä½:${r.rating.price}â­): ${r.comment}`;

    // åˆªé™¤æŒ‰éˆ•ï¼šç™»å…¥ä½¿ç”¨è€…åˆªè‡ªå·±ç•™è¨€ OR è¨ªå®¢åˆªè‡ªå·±ç•™è¨€
    const currentName = loggedIn ? currentUser : "è¨ªå®¢";
    if (r.username === currentName) {
      const btn = document.createElement("button");
      btn.innerText = "åˆªé™¤";
      btn.onclick = () => {
        reviews.splice(index, 1);
        localStorage.setItem(restaurantName, JSON.stringify(reviews));
        renderReviews(reviews, restaurantName);
      };
      li.appendChild(btn);
    }

    reviewsUl.appendChild(li);
  });
}

// ===== é€å‡ºç•™è¨€ =====
const submitReview = document.getElementById("submitReview");
submitReview.onclick = () => {
  const restaurantName = currentRestaurant.innerText;
  const comment = document.getElementById("commentInput").value.trim();
  if (!comment) return alert("è«‹è¼¸å…¥ç•™è¨€å…§å®¹");

  // å–å¾—è©•åˆ†
  const rating = {};
  document.querySelectorAll(".stars").forEach(starDiv => {
    const spans = starDiv.querySelectorAll("span");
    rating[starDiv.dataset.category] = Array.from(spans).filter(s => s.style.color === "gold").length;
  });

  const reviews = JSON.parse(localStorage.getItem(restaurantName)) || [];
  // ä½¿ç”¨ç™»å…¥åç¨±æˆ–è¨ªå®¢
  const currentName = loggedIn ? currentUser : "è¨ªå®¢";

  // çµ¦ç•™è¨€ä¸€å€‹éš¨æ©Ÿ IDï¼Œæ–¹ä¾¿è¨ªå®¢åˆªé™¤è‡ªå·±ç•™è¨€
  const reviewId = Date.now() + Math.random().toString(36).substr(2, 5);

  reviews.push({ id: reviewId, username: currentName, comment, rating });
  localStorage.setItem(restaurantName, JSON.stringify(reviews));

  renderReviews(reviews, restaurantName);
  document.getElementById("commentInput").value = "";

  // é‡ç½®æ˜Ÿæ˜Ÿ
  document.querySelectorAll(".stars").forEach(starDiv => {
    starDiv.querySelectorAll("span").forEach(s => s.style.color = "gold");
  });
};

/* ===================== åˆå§‹åŒ–ä¸€äº› UI ===================== */
updateDistricts();
updateCustomDistricts();

/* ----------------- favorite sidebar toggle ----------------- */
document.getElementById('toggleFavorites').addEventListener('click', () => {
  document.getElementById('favoriteSidebar').classList.toggle('active');
});
</script>
</body>
</html>
