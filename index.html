<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç¾é£Ÿæ¨è–¦å™¨</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
/* -------------------- ä½ çš„åŸå§‹æ¨£å¼ï¼ˆæœªä¿®æ”¹ï¼‰ -------------------- */

body {
  font-family: "Noto Sans TC", sans-serif;
  background: #fff8f0;
  color: #4a3b2c;
  margin: 0;
  padding: 0;
}

.hero {
  background-image: url("https://img.freepik.com/premium-vector/food-pattern-seamless_534604-531.jpg");
  background-size: cover;
  background-position: center;
  color: #fff8f0;
  text-align: center;
  padding: 4rem 1rem;
  position: relative;
}

.hero::after {
  content: "";
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(245, 139, 84, 0.3);
  z-index: 0;
}

.hero h1 {
  position: relative; z-index: 1;
  font-size: 2.8rem;
  letter-spacing: 0.05em;
  font-weight: 700;
  color: #fff8f0;
  margin: 0;
  text-shadow: 1px 1px 4px rgba(0,0,0,0.1);
}

header {
  background: #f4c095;
  display: flex;
  justify-content: center;
  gap: 2rem;
  padding: 1rem 0;
  position: sticky;
  top: 0;
  z-index: 2;
  border-bottom: 2px solid #f58b54;
}

header a {
  text-decoration: none;
  color: #4a3b2c;
  font-weight: 600;
  font-size: 1.1rem;
  transition: 0.3s;
}

header a:hover { color: #f58b54; }

section {
  display: none;
  padding: 2rem;
  max-width: 700px;
  margin: auto;
  background: #fff0e6;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(245, 139, 84, 0.15);
  margin-top: 2rem;
  border: 1px solid #f4c095;
}

section.active { display: block; }

h2 {
  text-align: center;
  color: #f58b54;
  border-bottom: 2px solid #f58b54;
  padding-bottom: 0.5rem;
}

label { display: block; margin: 10px 0; color: #4a3b2c; }

select, input[type="text"], button {
  width: 100%;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #f4c095;
  font-size: 1rem;
  background: #fff8f0;
  color: #4a3b2c;
}

select:focus, input[type="text"]:focus {
  outline: none;
  border-color: #f58b54;
  box-shadow: 0 0 5px #f58b54;
}

.checkbox-group {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.checkbox-group label {
  background: #fff0e6;
  border-radius: 8px;
  padding: 6px 12px;
  cursor: pointer;
  color: #4a3b2c;
  border: 1px solid #f4c095;
  transition: background 0.3s;
}

.checkbox-group label:hover { background: #ffe3d1; }

button {
  background-color: #f58b54;
  color: white;
  border: none;
  cursor: pointer;
  margin-top: 20px;
  font-weight: 700;
  transition: 0.3s;
}

button:hover { background-color: #f79465; }

#map, #mapFilter, #mapCustom {
  height: 300px;
  width: 100%;
  margin-top: 10px;
  border-radius: 12px;
}

/* æ”¶è—å´æ¬„ */
#toggleFavorites {
  position: fixed;
  top: 70px;
  left: 20px;
  background-color: #ff8c42;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 10px 16px;
  font-size: 18px;
  cursor: pointer;
  z-index: 1100;
}

#favoriteSidebar {
  position: fixed;
  top: 0; left: -300px;
  width: 280px; height: 100%;
  background-color: #fff8f0;
  box-shadow: 2px 0 10px rgba(0,0,0,0.2);
  overflow-y: auto;
  transition: left 0.4s ease;
  z-index: 1000;
  padding: 150px 20px 20px 20px;
}

#favoriteSidebar.active { left: 0; }

#favoriteSidebar ul { list-style: none; padding: 0; }

/* ç•™è¨€å€ */
#reviewArea { margin-top: 20px; }

</style>
</head>
<body>

<!-- å·¦ä¸Šè§’ç™»å…¥å€ -->
<div id="loginArea" style="position: fixed; top: 10px; left: 10px; z-index: 10; background: #f4c095; padding: 5px 10px; border-radius: 8px; border: 1px solid #f58b54;">
  <span id="welcomeText">æœªç™»å…¥</span>
  <button id="loginBtn" style="margin-left: 10px;">ç™»å…¥</button>
</div>

<div class="hero">
  <h1>ç¾é£Ÿæ¨è–¦å™¨</h1>
</div>

<header>
  <a href="#" onclick="showSection('random')">éš¨æ©ŸæŠ½é¸</a>
  <a href="#" onclick="showSection('filter')">åˆ†é¡ç¯©é¸</a>
  <a href="#" onclick="showSection('custom')">è¼¸å…¥éœ€æ±‚</a>
  <a href="#" onclick="showSection('content')">ç¶²å‹ç•™è¨€å€</a>
</header>

<!-- ======================
      éš¨æ©ŸæŠ½é¸
======================= -->
<section id="random" class="active">
  <h2>ğŸ² éš¨æ©ŸæŠ½é¸</h2>
  <form id="randomForm">

    <label>åŸå¸‚ï¼š
      <select id="citySelect" onchange="updateDistricts()">
        <option value="">è«‹é¸æ“‡åŸå¸‚</option>
        <option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option>
        <option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
        <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
        <option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option>
        <option value="å°å—å¸‚">å°å—å¸‚</option>
        <option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
      </select>
    </label>

    <label>å€åŸŸï¼š
      <select id="districtSelect">
        <option value="">è«‹å…ˆé¸æ“‡åŸå¸‚</option>
      </select>
    </label>

    <label>ä¸»é£Ÿé¡å‹ï¼š
      <select id="mainType" onchange="checkOtherType()">
        <option value="">è«‹é¸æ“‡</option>
        <option value="é£¯">é£¯</option>
        <option value="éºµ">éºµ</option>
        <option value="ç”œé»">ç”œé»</option>
        <option value="é£²æ–™">é£²æ–™</option>
        <option value="å…¶ä»–">å…¶ä»–</option>
      </select>
    </label>

    <label id="otherInputLabel" style="display:none;">
      è‡ªå®šç¾©ä¸»é£Ÿé¡å‹ï¼š
      <input type="text" id="otherInput" placeholder="ä¾‹å¦‚ï¼šå£½å¸ã€ç‡’è‚‰ã€æ—©åˆé¤â€¦">
    </label>

    <label>å£å‘³ï¼š</label>
    <div class="checkbox-group" id="tasteChecks">
      <label><input type="checkbox" value="é¹¹">é¹¹</label>
      <label><input type="checkbox" value="ç”œ">ç”œ</label>
      <label><input type="checkbox" value="è¾£">è¾£</label>
      <label><input type="checkbox" value="é…¸">é…¸</label>
    </div>

    <label>åƒ¹ä½ï¼š</label>
    <div class="checkbox-group" id="priceChecks">
      <label><input type="checkbox" value="ä¾¿å®œ">ä¾¿å®œ</label>
      <label><input type="checkbox"value="ä¸­ç­‰">ä¸­ç­‰</label>
      <label><input type="checkbox"value="é«˜ç´š">é«˜ç´š</label>
    </div>

    <button type="button" onclick="randomRecommend()">é–‹å§‹éš¨æ©Ÿæ¨è–¦ï¼</button>
  </form>

  <div id="recommendation"></div>
  <div id="map"></div>
</section>

<!-- ======================
      åˆ†é¡ç¯©é¸
======================= -->
<section id="filter">
  <h2>ğŸ± åˆ†é¡ç¯©é¸</h2>

  <div class="category-buttons">
    <button onclick="filterCategory('é«˜CPå€¼')">é«˜CPå€¼</button>
    <button onclick="filterCategory('ç´„æœƒé¤å»³')">ç´„æœƒé¤å»³</button>
    <button onclick="filterCategory('å¤šäººèšæœƒ')">å¤šäººèšæœƒ</button>
    <button onclick="filterCategory('ç”œé»ä¸‹åˆèŒ¶')">ç”œé»ä¸‹åˆèŒ¶</button>
    <button onclick="filterCategory('å¤œè²“å­')">å¤œè²“å­</button>
    <button onclick="filterCategory('è¶•æ™‚é–“')">è¶•æ™‚é–“</button>
    <button onclick="filterCategory('å¤–å¸¶å¤–é€å‹å–„')">å¤–å¸¶å¤–é€å‹å–„</button>
    <button onclick="filterCategory('ä¸‹é›¨å¤©')">ä¸‹é›¨å¤©</button>
  </div>

  <ul id="restaurantList"></ul>
  <div id="mapFilter"></div>
</section>

<!-- ======================
      è¼¸å…¥éœ€æ±‚
======================= -->
<section id="custom">
  <h2>ğŸ” è¼¸å…¥éœ€æ±‚</h2>

  <label>åŸå¸‚ï¼š
    <select id="customCity" onchange="updateCustomDistricts()">
      <option value="">è«‹é¸æ“‡åŸå¸‚</option>
      <option value="å°åŒ—å¸‚">å°åŒ—å¸‚</option>
      <option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option>
      <option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
      <option value="å°ä¸­å¸‚">å°ä¸­å¸‚</option>
      <option value="å°å—å¸‚">å°å—å¸‚</option>
      <option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option>
    </select>
  </label>

  <label>å€åŸŸï¼š
    <select id="customDistrict">
      <option value="">è«‹å…ˆé¸æ“‡åŸå¸‚</option>
    </select>
  </label>

  <label>è«‹è¼¸å…¥æ‚¨çš„éœ€æ±‚ï¼ˆä¾‹ï¼šæˆ‘æƒ³åƒæ‹‰éºµã€æƒ³æ‰¾ç´„æœƒé¤å»³â€¦ï¼‰ï¼š
    <input id="freeText" type="text" placeholder="ä¾‹å¦‚ï¼šæˆ‘æƒ³åƒä¾¿å®œæ‹‰éºµ">
  </label>

  <button onclick="customSearch()">é€å‡ºæœå°‹</button>

  <div id="customResults"></div>
  <div id="mapCustom"></div>
</section>

<!-- ======================
      ç¶²å‹ç•™è¨€å€
======================= -->
<section id="content">
  <h2>ç¶²å‹ç•™è¨€å€</h2>

  <div id="searchArea">
    <input type="text" id="searchRestaurant" placeholder="è¼¸å…¥é¤å»³åç¨±ï¼Œä¾‹å¦‚ï¼šé˜¿å®—éºµç·š">
    <button id="searchBtn">æœå°‹è©•è«–</button>
  </div>

  <div id="reviewArea" style="display:none;">
    <h3 id="currentRestaurant"></h3>

    <textarea id="commentInput" placeholder="è¼¸å…¥ç”¨é¤å¿ƒå¾—..."></textarea>
    <button id="submitReview">é€å‡ºè©•è«–</button>

    <ul id="reviewsUl"></ul>
  </div>
</section>

<!-- ======================
      æ”¶è—å´æ¬„
======================= -->
<button id="toggleFavorites">â˜° æ”¶è—</button>

<div id="favoriteSidebar">
  <h3>æˆ‘çš„æ”¶è—</h3>
  <ul id="favoritesUl"></ul>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ===================== CONFIG ===================== */
async function postAPI(payload) {
  try {
    const res = await fetch("https://script.google.com/macros/s/AKfycbzQDmgTSxyPKTBPqEmW3okvpEmXwUUVwG-amxBGe5oVhSuO5dlzgFWgbnqzt69QjzEE/exec", { //å‘¼å«proxy server
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      mode: 'cors',
      body: JSON.stringify(payload)
    });
    const data = await res.text(); //å›å‚³jsonç‰©ä»¶
    return JSON.parse(data);
  } catch (err) {
    console.error('postAPI error', err);
    return { ok: false, error: err.message || String(err) };
  }
}

/* ===================== åœ°åœ–åˆå§‹åŒ–ï¼ˆLeafletï¼‰ ===================== */
const defaultCenter = [25.033, 121.565]; // å°åŒ—ä¸­å¿ƒä½œç‚ºé è¨­
let map = L.map('map').setView(defaultCenter, 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let mapFilter = L.map('mapFilter').setView(defaultCenter, 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(mapFilter);

let mapCustom = L.map('mapCustom').setView(defaultCenter, 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(mapCustom);

/* marker holders */
let singleMarker = null;
let filterMarkers = [];
let customMarkers = [];

/* -------------------- UI helpers -------------------- */
function showSection(id){
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) el.classList.add('active');
}

/* -------------------- city/district data & helpers -------------------- */
const districts = {
  "å°åŒ—å¸‚":["åŒ—æŠ•å€","å£«æ—å€","ä¸­å±±å€","å…§æ¹–å€","å¤§åŒå€","æ¾å±±å€","å¤§å®‰å€","ä¿¡ç¾©å€","å—æ¸¯å€","ä¸­æ­£å€","è¬è¯å€","æ–‡å±±å€"],
  "æ–°åŒ—å¸‚":["æ¿æ©‹å€","æ–°èŠå€","ä¸­å’Œå€","æ°¸å’Œå€","ä¸‰é‡å€","è˜†æ´²å€","æ·¡æ°´å€","ä¸‰å³½å€"],
  "æ¡ƒåœ’å¸‚":["æ¡ƒåœ’å€","ä¸­å£¢å€","å¹³é®å€","å…«å¾·å€","è˜†ç«¹å€"],
  "å°ä¸­å¸‚":["åŒ—å€","è¥¿å€","å—å€","æ±å€","è¥¿å±¯å€"],
  "å°å—å¸‚":["ä¸­è¥¿å€","æ±å€","å—å€","åŒ—å€"],
  "é«˜é›„å¸‚":["é¹½åŸ•å€","é¼“å±±å€","å·¦ç‡Ÿå€","æ¥ æ¢“å€","å°æ¸¯å€"]
};

function updateDistricts(){
  const city = document.getElementById('citySelect').value;
  const sel = document.getElementById('districtSelect');
  sel.innerHTML = '<option value="">å…¨éƒ¨</option>';
  if (city && districts[city]) {
    districts[city].forEach(d => {
      const o = document.createElement('option'); o.value = d; o.textContent = d; sel.appendChild(o);
    });
  } else {
    sel.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡åŸå¸‚</option>';
  }
}
function updateCustomDistricts(){
  const city = document.getElementById('customCity').value;
  const sel = document.getElementById('customDistrict');
  sel.innerHTML = '<option value="">å…¨éƒ¨</option>';
  if (city && districts[city]) {
    districts[city].forEach(d => {
      const o = document.createElement('option'); o.value = d; o.textContent = d; sel.appendChild(o);
    });
  } else {
    sel.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡åŸå¸‚</option>';
  }
}
function checkOtherType(){
  const main = document.getElementById('mainType').value;
  document.getElementById('otherInputLabel').style.display = main === 'å…¶ä»–' ? 'block' : 'none';
}

/* ===================== Authentication & Favorites ===================== */
let loggedIn = false;
let currentUser = null;
const welcomeText = document.getElementById('welcomeText');
const loginBtn = document.getElementById('loginBtn');

loginBtn.addEventListener('click', async () => {
  if (!loggedIn) {
    const name = prompt('è«‹è¼¸å…¥å¸³è™Ÿ (username)');
    if (!name) return;
    const pw = prompt('è«‹è¼¸å…¥å¯†ç¢¼');
    if (!pw) return;
    // å…ˆå˜—è©¦ login
    let res = await postAPI({ action: 'login', username: name, password: pw });
    if (res && res.ok) {
      loggedIn = true; currentUser = name;
      welcomeText.textContent = `æ‚¨å¥½, ${name}`; loginBtn.textContent = 'ç™»å‡º';
      loadFavoritesForCurrentUser();
      alert('ç™»å…¥æˆåŠŸ');
      return;
    }
    // è‹¥ login å¤±æ•—ï¼Œå˜—è©¦è¨»å†Š
    res = await postAPI({ action: 'register', username: name, password: pw });
    if (res && res.ok) {
      loggedIn = true; currentUser = name;
      welcomeText.textContent = `æ‚¨å¥½, ${name}`; loginBtn.textContent = 'ç™»å‡º';
      loadFavoritesForCurrentUser();
      alert('å·²è¨»å†Šä¸¦ç™»å…¥');
      return;
    }
    alert('ç™»å…¥/è¨»å†Šå¤±æ•—ï¼š' + (res.error || JSON.stringify(res)));
  } else {
    // logout
    loggedIn = false; currentUser = null;
    welcomeText.textContent = 'æœªç™»å…¥'; loginBtn.textContent = 'ç™»å…¥';
    document.getElementById('favoritesUl').innerHTML = '';
    alert('å·²ç™»å‡º');
  }
});

async function addToFavorites(place) {
  if (!loggedIn) return alert('è«‹å…ˆç™»å…¥æ‰èƒ½æ”¶è—');
  const resp = await postAPI({ action: 'addFavorite', username: currentUser, place });
  if (resp && resp.ok) {
    alert('å·²åŠ å…¥æ”¶è—');
    loadFavoritesForCurrentUser();
  } else {
    alert('åŠ å…¥æ”¶è—å¤±æ•—ï¼š' + (resp.error || JSON.stringify(resp)));
  }
}

async function loadFavoritesForCurrentUser() {
  if (!loggedIn) return;
  const resp = await postAPI({ action: 'getFavorites', username: currentUser });
  const ul = document.getElementById('favoritesUl');
  ul.innerHTML = '';
  if (resp && resp.ok && Array.isArray(resp.favorites)) {
    resp.favorites.forEach(f => {
      const li = document.createElement('li');
      li.innerHTML = `<span>${f.name} â€” ${f.address || ''}</span>
                      <button style="margin-left:8px" onclick='removeFavorite("${f.name.replace(/"/g,"\\\"")}")'>ç§»é™¤</button>`;
      ul.appendChild(li);
    });
  }
}

async function removeFavorite(name) {
  if (!loggedIn) return alert('è«‹å…ˆç™»å…¥');
  const resp = await postAPI({ action: 'removeFavorite', username: currentUser, name });
  if (resp && resp.ok) {
    loadFavoritesForCurrentUser();
  } else {
    alert('åˆªé™¤å¤±æ•—');
  }
}

/* ===================== éš¨æ©ŸæŠ½é¸ï¼ˆå‘¼å« Gemin i via backend recommendï¼‰ ===================== */
async function randomRecommend() {
  // æ”¶é›†æ¢ä»¶
  const city = document.getElementById('citySelect').value;
  const district = document.getElementById('districtSelect').value;
  const mainType = document.getElementById('mainType').value;
  const otherType = document.getElementById('otherInput').value;
  const tastes = Array.from(document.querySelectorAll('#tasteChecks input[type=checkbox]:checked')).map(i=>i.value);
  const prices = Array.from(document.querySelectorAll('#priceChecks input[type=checkbox]:checked')).map(i=>i.value);

  const queryType = mainType === 'å…¶ä»–' && otherType ? otherType : (mainType || '');

  const options = {
    mode: 'random',
    city, district,
    mainType: queryType,
    tastes, prices
  };

  // UI
  const recDiv = document.getElementById('recommendation');
  recDiv.innerHTML = 'è«‹ç¨å€™ï¼Œæ­£åœ¨ä½¿ç”¨ Gemini ç”Ÿæˆæ¨è–¦...';

  const resp = await postAPI({ action: 'recommend', options });
  if (!resp || !resp.ok) {
    recDiv.innerHTML = 'æ¨è–¦å¤±æ•—ï¼š' + (resp ? (resp.error || JSON.stringify(resp)) : 'ç„¡å›æ‡‰');
    return;
  }

  const list = resp.restaurants;
  if (!Array.isArray(list) || list.length === 0) {
    recDiv.innerHTML = 'æ²’æœ‰çµæœ';
    return;
  }

  // å¾ç”Ÿæˆæ¸…å–®ä¸­éš¨æ©ŸæŒ‘ä¸€é–“é¡¯ç¤ºã€ä¸¦åœ¨åœ°åœ–ä¸Šæ¨™è¨˜
  const choice = list[Math.floor(Math.random()*list.length)];
  renderSingleRecommendation(choice);
}

/* é¡¯ç¤ºå–®ä¸€æ¨è–¦ (random) */
function renderSingleRecommendation(choice) {
  const recDiv = document.getElementById('recommendation');
  recDiv.innerHTML = '';
  if (!choice) { recDiv.innerHTML = 'æ²’æœ‰æ¨è–¦'; return; }
  const title = document.createElement('h3'); title.textContent = choice.name || 'Unnamed';
  const p = document.createElement('p'); p.innerHTML = `${choice.address || ''} ${choice.price ? 'ï½œ' + choice.price : ''}<br>${choice.reason || ''}`;
  const favBtn = document.createElement('button'); favBtn.textContent = 'â˜… æ”¶è—'; favBtn.onclick = () => addToFavorites({
    name: choice.name, address: choice.address, lat: choice.lat, lng: choice.lng
  });

  recDiv.appendChild(title); recDiv.appendChild(p); recDiv.appendChild(favBtn);

  // map
  if (singleMarker) {
    map.removeLayer(singleMarker);
    singleMarker = null;
  }
  if (choice.lat && choice.lng) {
    singleMarker = L.marker([choice.lat, choice.lng]).addTo(map).bindPopup(`<b>${choice.name}</b><br>${choice.address || ''}`).openPopup();
    map.setView([choice.lat, choice.lng], 15);
  } else {
    // å¦‚æœæ²’æœ‰åº§æ¨™ï¼Œå˜—è©¦ä¸æ”¹è®Šåœ°åœ–ä¸¦é¡¯ç¤ºæç¤º
    map.setView(defaultCenter, 12);
  }
}

/* ===================== åˆ†é¡ç¯©é¸ï¼ˆé¡¯ç¤ºå¤šç­†ï¼‰ ===================== */
async function filterCategory(category) {
  const city = document.getElementById('citySelect').value;
  const district = document.getElementById('districtSelect').value;
  const options = { mode: 'category', category, city, district };

  const listDiv = document.getElementById('restaurantList');
  listDiv.innerHTML = 'æœå°‹ä¸­ï¼ˆç”± Gemini ç”Ÿæˆï¼‰...';

  const resp = await postAPI({ action: 'recommend', options });
  if (!resp || !resp.ok) {
    listDiv.innerHTML = 'æœå°‹å¤±æ•—ï¼š' + (resp ? (resp.error || JSON.stringify(resp)) : 'ç„¡å›æ‡‰');
    return;
  }
  const list = resp.restaurants || [];
  listDiv.innerHTML = '';

  // æ¸…é™¤åŸæœ¬ markers
  filterMarkers.forEach(m => mapFilter.removeLayer(m));
  filterMarkers = [];

  if (list.length === 0) {
    listDiv.innerHTML = '<li>ç„¡çµæœ</li>';
    return;
  }

  list.forEach(p => {
    const li = document.createElement('li');
    li.innerHTML = `<span style="display:block">${p.name} ${p.price ? 'ï½œ' + p.price : ''} <br><small>${p.address || ''}</small></span>
                    <button style="margin-left:8px">æ”¶è—</button>`;
    // button onclick
    const btn = li.querySelector('button');
    btn.onclick = () => addToFavorites({ name: p.name, address: p.address, lat: p.lat, lng: p.lng });

    listDiv.appendChild(li);

    if (p.lat && p.lng) {
      const m = L.marker([p.lat, p.lng]).addTo(mapFilter).bindPopup(`<b>${p.name}</b><br>${p.address || ''}`);
      filterMarkers.push(m);
    }
  });

  // èšç„¦åˆ°ç¬¬ä¸€å€‹æœ‰åº§æ¨™çš„é»
  const first = list.find(x => x.lat && x.lng);
  if (first) mapFilter.setView([first.lat, first.lng], 13);
}

/* ===================== è‡ªè¨‚éœ€æ±‚ï¼ˆfree textï¼‰ ===================== */
async function customSearch() {
  const city = document.getElementById('customCity').value;
  const district = document.getElementById('customDistrict').value;
  const freeText = document.getElementById('freeText').value.trim();
  if (!freeText) return alert('è«‹è¼¸å…¥éœ€æ±‚');

  const options = { mode: 'custom', city, district, query: freeText };

  const resultsDiv = document.getElementById('customResults');
  resultsDiv.innerHTML = 'æœå°‹ä¸­ï¼ˆç”± Gemini ç”Ÿæˆï¼‰...';

  const resp = await postAPI({ action: 'recommend', options });
  if (!resp || !resp.ok) {
    resultsDiv.innerHTML = 'æœå°‹å¤±æ•—ï¼š' + (resp ? (resp.error || JSON.stringify(resp)) : 'ç„¡å›æ‡‰');
    return;
  }

  const list = resp.restaurants || [];
  resultsDiv.innerHTML = '';

  // æ¸…æ‰ custom markers
  customMarkers.forEach(m => mapCustom.removeLayer(m));
  customMarkers = [];

  if (list.length === 0) {
    resultsDiv.innerHTML = '<div>ç„¡çµæœ</div>';
    return;
  }

  list.forEach(p => {
    const el = document.createElement('div');
    el.style.borderBottom = '1px solid #f4c095';
    el.style.padding = '8px 0';
    el.innerHTML = `<strong>${p.name}</strong><div>${p.address || ''}</div><div style="font-size:0.9rem;">${p.reason || ''}</div>
                    <button style="margin-top:6px">æ”¶è—</button>`;
    const btn = el.querySelector('button');
    btn.onclick = () => addToFavorites({ name: p.name, address: p.address, lat: p.lat, lng: p.lng });
    resultsDiv.appendChild(el);

    if (p.lat && p.lng) {
      const m = L.marker([p.lat, p.lng]).addTo(mapCustom).bindPopup(`<b>${p.name}</b><br>${p.address || ''}`);
      customMarkers.push(m);
    }
  });

  const first = list.find(x => x.lat && x.lng);
  if (first) mapCustom.setView([first.lat, first.lng], 13);
}

/* ===================== ç•™è¨€å€ï¼ˆç°¡å–® localStorageï¼‰ ===================== */
document.getElementById('searchBtn').addEventListener('click', () => {
  const name = document.getElementById('searchRestaurant').value.trim();
  if (!name) return alert('è«‹è¼¸å…¥é¤å»³åç¨±');
  document.getElementById('currentRestaurant').textContent = name;
  document.getElementById('reviewArea').style.display = 'block';
  renderReviews(name);
});

function renderReviews(name) {
  const arr = JSON.parse(localStorage.getItem('reviews_' + name) || '[]');
  const ul = document.getElementById('reviewsUl');
  ul.innerHTML = '';
  arr.forEach((r, idx) => {
    const li = document.createElement('li');
    li.textContent = `${r.username || 'è¨ªå®¢'}: ${r.comment}`;
    if (r.username === currentUser) {
      const btn = document.createElement('button'); btn.textContent = 'åˆªé™¤'; btn.style.marginLeft = '8px';
      btn.onclick = () => {
        arr.splice(idx,1);
        localStorage.setItem('reviews_' + name, JSON.stringify(arr));
        renderReviews(name);
      };
      li.appendChild(btn);
    }
    ul.appendChild(li);
  });
}

document.getElementById('submitReview').addEventListener('click', () => {
  const name = document.getElementById('currentRestaurant').textContent;
  if (!name) return alert('è«‹å…ˆæœå°‹é¤å»³');
  const comment = document.getElementById('commentInput').value.trim();
  if (!comment) return alert('è«‹è¼¸å…¥ç•™è¨€');
  const arr = JSON.parse(localStorage.getItem('reviews_' + name) || '[]');
  arr.push({ username: loggedIn ? currentUser : 'è¨ªå®¢', comment, createdAt: Date.now() });
  localStorage.setItem('reviews_' + name, JSON.stringify(arr));
  document.getElementById('commentInput').value = '';
  renderReviews(name);
});

/* ===================== åˆå§‹åŒ–ä¸€äº› UI ===================== */
updateDistricts();
updateCustomDistricts();

/* ----------------- favorite sidebar toggle ----------------- */
document.getElementById('toggleFavorites').addEventListener('click', () => {
  document.getElementById('favoriteSidebar').classList.toggle('active');
});
</script>
</body>
</html>
